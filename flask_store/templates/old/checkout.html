{% extends "/common/base.html" %}

{% block content %}
<div style="padding: 20px; max-width: 800px; margin: auto;">
    
    <h2 class="mb-4">Checkout</h2>
    
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #ddd;">
        <h4 style="margin-top: 0;">Order Total: <span style="color: green;">${{ "%.2f"|format(grand_total) }}</span></h4>
        <p style="margin-bottom: 0; color: #666;">Please review your shipping address and select a payment method below.</p>
    </div>

    <form method="POST" action="{{ url_for('cart.checkout') }}">
        
        <div style="margin-bottom: 30px;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">Shipping Address:</label>
            <textarea name="address" required 
                      style="width: 100%; height: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;"
                      placeholder="Enter your full shipping address...">{{ current_user.address if current_user.address else '' }}</textarea>
        </div>

        <div style="margin-bottom: 30px;">
            <label style="font-weight: bold; display: block; margin-bottom: 15px;">Select Payment Method:</label>

            {% if current_user.credit_cards %}
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% for card in current_user.credit_cards %}
                        {% if card.is_active %}
                        <label style="border: 1px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; background: #fff;">
                            
                            <input type="radio" name="card_id" value="{{ card.id }}" required style="margin-right: 15px; transform: scale(1.2);">
                            
                            <div>
                                <span style="font-weight: bold; font-size: 1.1em;">
                                    {{ card.name }}
                                </span>
                                <br>
                                <span style="color: #555; font-family: monospace;">
                                    **** **** **** {{ card.Card_Number[-4:] }}
                                </span>
                                <span style="color: #888; font-size: 0.9em; margin-left: 10px;">
                                    (Exp: {{ card.Expiration_Date.strftime('%m/%y') }})
                                </span>
                            </div>
                        </label>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <div style="margin-top: 30px;">
                    <button type="submit" style="background: green; color: white; padding: 12px 30px; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer;">
                        Confirm Payment
                    </button>
                    <a href="{{ url_for('users.credit') }}" style="margin-left: 20px; color: #007bff; text-decoration: none;">Manage/Add Cards</a>
                </div>

            {% else %}
                <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; border: 1px solid #ffeeba;">
                    <strong>No cards found!</strong> You need to add a credit card to your profile before you can checkout.
                </div>
                <div style="margin-top: 20px;">
                    <a href="{{ url_for('users.credit') }}" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                        Add a Credit Card
                    </a>
                </div>
            {% endif %}
        </div>

    </form>
</div>
{% endblock %}
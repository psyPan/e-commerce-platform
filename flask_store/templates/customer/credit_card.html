{% extends "/customer/base_dashboard.html" %}

{% block credit_card %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/old/credit_card.css') }}">

<div class="credit-wrapper">

    <div class="credit-container">
        
        <div class="card-list" id="cardSection">

            <h1 class="credit-title">My Credit Cards</h1>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }}" style="padding: 10px; margin-bottom: 20px; border-radius: 5px; background: #e9ecef;">
                      {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            {% if current_user.credit_cards %}
                {% for card in current_user.credit_cards %}
                    {% if card.is_active %}
                    <div class="card-item">
                        <div class="card-left">
                            <div class="card-icon">ðŸ’³</div>
                            <div class="card-info">
                                <div class="bank-name">{{ card.name }}</div>
                                <div class="card-number">**** **** **** {{ card.Card_Number[-4:] }}</div>
                            </div>
                        </div>
                
                        <div class="card-right">
                            <span class="card-type">Exp: {{ card.Expiration_Date.strftime('%m/%y') }}</span>
                
                            <form action="{{ url_for('users.delete_card', card_id=card.id) }}" method="POST" style="display:inline;">
                                <button type="button" class="delete-card-btn" onclick="confirmDelete(this.form)">âœ•</button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p style="text-align: center; color: #777; margin: 40px 0;">You haven't added any credit cards yet.</p>
            {% endif %}
        
            <div class="card-actions">
                <button class="edit-btn" onclick="enterEditMode()">Edit Cards</button>
        
                <div class="edit-actions">
                    <button class="cancel-btn" onclick="exitEditMode()">Done</button>
                    <button class="add-card-btn" onclick="openPopup()">Add a Card</button>
                </div>
            </div>
        
        </div>
    </div>
</div>


<div id="popup" class="popup">
    <div class="popup-inner">
        <h2 class="popup-title">New Card</h2>

        <form method="POST" action="{{ url_for('users.add_card') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">

            <input type="text" name="name" class="input-field" placeholder="Cardholder Name" required>
            
            <input type="text" name="card_number" class="input-field" placeholder="Card Number (16 digits)" 
                   maxlength="19" pattern="\d*" title="Digits only" required>

            <div class="two-input">
                <input type="text" name="expiry" class="input-field" placeholder="MM/YY" 
                       pattern="(0[1-9]|1[0-2])\/[0-9]{2}" title="Format: MM/YY" required>
                       
                <input type="text" name="cvv" class="input-field" placeholder="CVV" 
                       maxlength="4" required>
            </div>

            <div class="popup-buttons">
                <button type="button" class="cancel-btn" onclick="closePopup()">Cancel</button>
                <button type="submit" class="add-btn">Add Card</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Popup Logic
    function openPopup() { document.getElementById("popup").classList.add("active"); }
    function closePopup() { document.getElementById("popup").classList.remove("active"); }

    // Edit Mode Logic
    function enterEditMode() {
        document.querySelector('.card-list').classList.add('edit-mode');
        // Hide the main Edit button, show action buttons
        document.querySelector('.edit-btn').style.display = 'none';
        document.querySelector('.edit-actions').style.display = 'flex';
    }
    
    function exitEditMode() {
        document.querySelector('.card-list').classList.remove('edit-mode');
        // Show the main Edit button, hide action buttons
        document.querySelector('.edit-btn').style.display = 'inline-block';
        document.querySelector('.edit-actions').style.display = 'none';
    }
    
    // Delete Confirmation
    function confirmDelete(form) {
        if (confirm("Are you sure you want to remove this card?")) {
            form.submit();
        }
    }
</script>

{% endblock credit_card %}
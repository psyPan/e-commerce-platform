{% extends "/customer/base_dashboard.html" %}
{% block my_profile %}
<div class="dashboard-card {% if form.errors %}editing{% endif %}" id="profileBox">
    <h1 class="dashboard-title">My Profile</h1>
    <div class="dashboard-view">
        <div class="profile-row">
            <span>Full Name</span>
            <p>{{ current_user.f_name }} {{ current_user.l_name }}</p>
        </div>
        <div class="profile-row">
            <span>Birth Date</span>
            <p>{{ current_user.birth }}</p>
        </div>
        <div class="profile-row">
            <span>Phone</span>
            <p>{{ current_user.phone }}</p>
        </div>
        <div class="profile-row">
            <span>Address</span>
            <p>{{ current_user.address }}</p>
        </div>
        <div class="profile-row">
            <span>Email</span>
            <p>{{ current_user.email }}</p>
        </div>
    </div>
    <div class="action-buttons action-buttons-view">
        <button type="button" class="edit-btn" onclick="enterEdit()">Edit Profile</button>
    </div>
    <form method="POST" class="dashboard-form" action="{{ url_for('users.update_profile') }}">
        {{ form.hidden_tag() }}
        <div class="dashboard-form-row">
            <div class="form-group">
                {{ form.f_name.label(class="form-label") }}
                {% if form.f_name.errors %}
                    {{ form.f_name(class="form-input is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.f_name.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.f_name(class="profile-input") }}
                {% endif %}
            </div>
            <div class="form-group">
                {{ form.l_name.label(class="form-label") }}
                {% if form.l_name.errors %}
                    {{ form.l_name(class="form-input is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.l_name.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.l_name(class="profile-input") }}
                {% endif %}
            </div>
        </div>
        <div class="dashboard-form-row">
            <div class="form-group">
                {{ form.email.label(class="form-label") }}
                {% if form.email.errors %}
                    {{ form.email(class="form-input is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.email.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.email(class="profile-input") }}
                {% endif %}
            </div>
        
            <div class="form-group">
                {{ form.phone.label(class="form-label") }}
                {% if form.phone.errors %}
                    {{ form.phone(class="form-input is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.phone.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.phone(class="profile-input") }}
                {% endif %}
            </div>
        </div>
        <div class="dashboard-form-row">
            <div class="form-group">
                {{ form.birth.label(class="form-label") }}
                {% if form.birth.errors %}
                    {{ form.birth(class="form-input is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.birth.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.birth(class="profile-input") }}
                {% endif %}
            </div>
        
            <div class="form-group">
                {{ form.address.label(class="form-label") }}
                {% if form.address.errors %}
                    {{ form.address(class="form-input is-invalid") }}
                    <div class="invalid-feedback">
                        {% for error in form.address.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% else %}
                    {{ form.address(class="profile-input") }}
                {% endif %}
            </div>
        </div>
        <div class="action-buttons action-buttons-form">
            <button type="button" class="cancel-btn" onclick="exitEdit()">Cancel</button>
            <button type="submit" class="save-btn">Save</button>
        </div>
    </form>
</div>

<script>
function enterEdit() {
    document.getElementById("profileBox").classList.add("editing");
}

function exitEdit() {
    document.getElementById("profileBox").classList.remove("editing");
}

// If form was submitted but had errors (server-side validation), keep editing open
document.addEventListener('DOMContentLoaded', function() {
    // If there is an alert-success, we assume things went well and we can close edit mode.
    // (Optional: You can remove this if you prefer manual closing)
    const successMessages = document.querySelectorAll('.alert-success');
    if (successMessages.length > 0) {
        exitEdit();
    }
});
</script>

<style>
    /* Styles to toggle between View/Edit.
       You can move these to profile.css eventually.
    */
    .dashboard-form { display: none; }
    .dashboard-view { display: block; }
    .action-buttons-view { display: block; }
    .action-buttons-form { display: none; }

    /* When the 'editing' class is applied via JS */
    .dashboard-card.editing .dashboard-form { display: block; }
    .dashboard-card.editing .dashboard-view { display: none; }
    .dashboard-card.editing .action-buttons-view { display: none; }
    .dashboard-card.editing .action-buttons-form { display: flex; gap: 10px; justify-content: flex-end; }
    
    .invalid-feedback { color: #dc3545; font-size: 0.875em; margin-top: 0.25rem; }
    .is-invalid { border-color: #dc3545 !important; }
    
    .dashboard-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;  /* Equal columns */
    gap: 20px;
    padding: 3px 0;
}
</style>
{% endblock my_profile %}
{% extends "index.html" %}

{% block navbar %}
<div class="navbar">
    <div class="logo">
        <a href="{{ url_for('users.home') }}">Our Logo</a>
    </div>
    <div class="nav-links">
        <a href="{{ url_for('users.home') }}">Home</a>
        <a href="{{ url_for('users.logout') }}">Log Out</a>
    </div>
</div>
{% endblock navbar %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='style/home.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='style/my_cart.css') }}">

<div class="cart-wrapper">

    <div class="cart-title">My Cart</div>

    {% if not cart_items %}
        <div style="text-align: center; padding: 50px;">
            <h3>Your cart is empty!</h3>
            <a href="{{ url_for('stores.list_stores') }}" style="color: blue; text-decoration: underline;">Start Shopping</a>
        </div>
    {% else %}

    <div class="cart-header">
        <div class="col-check">
            <input type="checkbox" id="select-all" checked>
        </div>        
        <div class="col-product">Select All ({{ cart_items|length }} items)</div>
        <div class="col-price">Unit Price</div>
        <div class="col-qty">Quantity</div>
        <div class="col-total">Total</div>
        <div class="col-action"></div>
    </div>

    {% for item, product in cart_items %}
    <div class="cart-item" data-price="{{ product.sell_price }}">
        <div class="col-check">
            <input type="checkbox" class="item-checkbox" checked>
        </div>        
        
        <div class="col-product product-info">
            <div class="product-img">
                {% if product.image %}
                <img src="{{ product.image }}" alt="{{ product.name }}" style="width:100%; height:100%; object-fit:contain;">
                {% else %}
                <div style="background:#ddd; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">No Img</div>
                {% endif %}
            </div>
            <div class="product-name">
                <strong>{{ product.name }}</strong>
                <br>
                <small style="color:gray;">{{ product.manufacturer }}</small>
            </div>
        </div>

        <div class="col-price">${{ "%.2f"|format(product.sell_price) }}</div>

        <div class="col-qty qty-box">
            <form action="{{ url_for('cart.add_to_cart', product_id=product.id) }}" method="POST" style="display:inline;">
                <input type="hidden" name="quantity" value="-1">
                <button type="submit" {% if item.quantity <= 1 %}disabled style="opacity:0.5; cursor:not-allowed"{% endif %}>-</button>
            </form>

            <input type="text" value="{{ item.quantity }}" readonly>

            <form action="{{ url_for('cart.add_to_cart', product_id=product.id) }}" method="POST" style="display:inline;">
                <input type="hidden" name="quantity" value="1">
                <button type="submit">+</button>
            </form>
        </div>

        <div class="col-total">
            ${{ "%.2f"|format(product.sell_price * item.quantity) }}
        </div>

        <div class="col-action">
            <a href="{{ url_for('cart.remove_from_cart', product_id=product.id) }}" 
               class="delete-btn" 
               onclick="return confirm('Remove {{ product.name }} from cart?');"
               style="text-decoration:none; display:flex; justify-content:center; align-items:center;">
                ✕
            </a>
        </div>
    </div>
    {% endfor %}

    <div class="cart-subtotal">
        <div></div> 
        <div>Subtotal</div>
        <div></div> 
        <div style="text-align:center;" id="subtotal-items">{{ cart_items|length }} items</div>
        <div style="text-align:center;" id="subtotal-price">${{ "%.2f"|format(subtotal) }}</div>
        <div></div> 
    </div>    

    <div class="cart-bottom">

        <div class="receiver-card">
            <h3>Receiver’s Information</h3>
            <div class="receiver-row">
                <span>User</span>
                <p>{{ current_user.username if current_user.username else 'Guest' }}</p>
            </div>
            <div class="receiver-row">
                <span>Email</span>
                <p>{{ current_user.email if current_user.email else 'N/A' }}</p>
            </div>
        </div>
        
        <div class="summary-card">
            <h3>Summary</h3>
        
            <div class="summary-row">
                <span>Subtotal</span>
                <span id="summary-subtotal">${{ "%.2f"|format(subtotal) }}</span>
            </div>
        
            <div class="summary-row">
                <span>Discount</span>
                <span id="summary-discount">-$0.00</span>
            </div>
        
            <div class="summary-row">
                <span>Shipping</span>
                <span id="summary-shipping">$0.00</span>
            </div>
        
            <div class="summary-row total">
                <span>Total</span>
                <span id="summary-total">${{ "%.2f"|format(subtotal) }}</span>
            </div>
        </div>

    </div>

    <div class="checkout-area">
        <button class="checkout-btn">Check Out</button>
    </div>
    {% endif %}

    <script>
        /* This script updates the "Total" and "Subtotal" on the screen immediately 
           when you check/uncheck boxes. 
           NOTE: Quantity changes now reload the page via the Python form, 
           so we removed the JS for +/- to prevent conflict.
        */
        function updateCartCalculations() {
            let items = document.querySelectorAll(".cart-item");
            let totalQty = 0;
            let totalPrice = 0;
        
            items.forEach(item => {
                const checkbox = item.querySelector(".item-checkbox");
                const price = parseFloat(item.dataset.price);
                const qtyInput = item.querySelector(".qty-box input[type='text']");
                const qty = parseInt(qtyInput.value);

                if (!checkbox || checkbox.checked) {
                    const itemTotal = price * qty;
                    // Update visual row total
                    // item.querySelector(".col-total").innerText = `$${itemTotal.toFixed(2)}`;
                    
                    totalQty += qty;
                    totalPrice += itemTotal;
                }
            });

            // Update Bottom Summaries
            const itemText = `${totalQty} item${totalQty !== 1 ? "s" : ""}`;
            const priceText = `$${totalPrice.toFixed(2)}`;

            if(document.getElementById("subtotal-items")) {
                document.getElementById("subtotal-items").innerText = itemText;
                document.getElementById("subtotal-price").innerText = priceText;
                document.getElementById("summary-subtotal").innerText = priceText;
                document.getElementById("summary-total").innerText = priceText;
            }
        }
        
        /* CHECKBOX LOGIC */
        const selectAll = document.getElementById("select-all");
        
        if(selectAll) {
            selectAll.addEventListener("change", () => {
                document.querySelectorAll(".item-checkbox").forEach(cb => {
                    cb.checked = selectAll.checked;
                });
                updateCartCalculations();
            });
        }
        
        document.addEventListener("change", (e) => {
            if (e.target.classList.contains("item-checkbox")) {
                const items = document.querySelectorAll(".item-checkbox");
                const checkedItems = document.querySelectorAll(".item-checkbox:checked");
                if(selectAll) {
                    selectAll.checked = items.length === checkedItems.length && items.length > 0;
                }
                updateCartCalculations();
            }
        });

        /* Initial Calculation on Load */
        updateCartCalculations();
    </script>    

</div>
{% endblock %}
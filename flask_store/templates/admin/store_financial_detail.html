{% extends "/common/base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ store.name }} - Financial Details</h1>
        <a href="{{ url_for('users.financial_report') }}" class="btn btn-secondary">
            Back to Overview
        </a>
    </div>

    <!-- Store Info Card -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4>Store Information</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>Store Name:</strong> {{ store.name }}</p>
                    <p><strong>Email:</strong> {{ store.email }}</p>
                    <p><strong>Phone:</strong> {{ store.phone }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Registration Date:</strong> {{ store.reg_date.strftime('%B %d, %Y') }}</p>
                    <p><strong>Current Balance:</strong> ${{ "{:,.2f}".format(store.balance or 0) }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>Total Products:</strong> {{ products_data|length }}</p>
                    <p><strong>Total Owners:</strong> {{ store.owners|length }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Revenue Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Revenue Trend (Last 6 Months)</h4>
        </div>
        <div class="card-body">
            <canvas id="revenueChart" height="80"></canvas>
        </div>
    </div>

    <!-- Product Performance Table -->
    <div class="card">
        <div class="card-header">
            <h4>Product Performance</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Product Name</th>
                            <th>Sell Price</th>
                            <th>Buy Price</th>
                            <th>Profit/Unit</th>
                            <th>Stock</th>
                            <th>Total Sold</th>
                            <th>Orders</th>
                            <th>Total Revenue</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products_data %}
                        <tr>
                            <td><strong>{{ product.name }}</strong></td>
                            <td>${{ product.sell_price }}</td>
                            <td>${{ product.buy_price }}</td>
                            <td class="text-success">${{ product.sell_price - product.buy_price }}</td>
                            <td>
                                {% if product.stock < 10 %}
                                    <span class="badge bg-danger">{{ product.stock }}</span>
                                {% elif product.stock < 50 %}
                                    <span class="badge bg-warning">{{ product.stock }}</span>
                                {% else %}
                                    <span class="badge bg-success">{{ product.stock }}</span>
                                {% endif %}
                            </td>
                            <td>{{ product.total_sold }}</td>
                            <td>{{ product.order_count }}</td>
                            <td>${{ "{:,.2f}".format(product.total_revenue) }}</td>
                            <td class="text-success fw-bold">${{ "{:,.2f}".format(product.total_profit) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-secondary">
                        <tr>
                            <th colspan="5">TOTAL</th>
                            <th>{{ products_data|sum(attribute='total_sold') }}</th>
                            <th>{{ products_data|sum(attribute='order_count') }}</th>
                            <th>${{ "{:,.2f}".format(products_data|sum(attribute='total_revenue')) }}</th>
                            <th class="text-success fw-bold">${{ "{:,.2f}".format(products_data|sum(attribute='total_profit')) }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Export Options -->
    <div class="mt-3 mb-5">
        <button class="btn btn-success" onclick="exportToCSV()">
            Export Products to CSV
        </button>
        <button class="btn btn-primary" onclick="window.print()">
            Print Report
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Revenue Trend Chart
const ctx = document.getElementById('revenueChart').getContext('2d');
const revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for month in monthly_data %}
            '{{ month.month }}',
            {% endfor %}
        ],
        datasets: [{
            label: 'Monthly Revenue ($)',
            data: [
                {% for month in monthly_data %}
                {{ month.revenue }},
                {% endfor %}
            ],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Revenue: $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2});
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

function exportToCSV() {
    let csv = 'Product Name,Sell Price,Buy Price,Profit per Unit,Stock,Total Sold,Orders,Total Revenue,Total Profit\n';
    
    {% for product in products_data %}
    csv += '"{{ product.name }}",' +
           '{{ product.sell_price }},' +
           '{{ product.buy_price }},' +
           '{{ product.sell_price - product.buy_price }},' +
           '{{ product.stock }},' +
           '{{ product.total_sold }},' +
           '{{ product.order_count }},' +
           '{{ product.total_revenue }},' +
           '{{ product.total_profit }}\n';
    {% endfor %}
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ store.name }}_products_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}
</script>

<style>
@media print {
    .btn { display: none; }
    canvas { max-height: 300px; }
}
</style>
{% endblock %}